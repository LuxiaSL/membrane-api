# .github/workflows/deploy.yml
name: Deploy Membrane API

on:
  push:
    branches: [main]
  workflow_dispatch:  # Manual trigger

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via rsync
        uses: burnett01/rsync-deployments@7.0.2
        with:
          switches: -avz --delete --exclude='node_modules' --exclude='.env' --exclude='dist/'
          path: ./
          remote_path: /opt/aethera-server/membrane-api/
          remote_host: ${{ secrets.VPS_HOST }}
          remote_user: ${{ secrets.VPS_USER }}
          remote_key: ${{ secrets.VPS_SSH_KEY }}

      - name: Install dependencies, build, and restart
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            cd /opt/aethera-server/membrane-api
            
            echo "üì¶ Installing dependencies (including dev for build)..."
            npm ci
            
            echo "üî® Building TypeScript..."
            npm run build
            
            echo "üßπ Removing dev dependencies..."
            npm prune --omit=dev
            
            echo "üîÑ Restarting service..."
            sudo systemctl restart membrane-api
            
            echo "‚è≥ Waiting for service to be healthy..."
            sleep 3
            for i in {1..10}; do
              if curl -sf http://localhost:3001/health > /dev/null 2>&1; then
                echo "‚úÖ Health check passed!"
                break
              fi
              echo "   Waiting... ($i/10)"
              sleep 2
            done
            
            # Final status check
            if curl -sf http://localhost:3001/health > /dev/null 2>&1; then
              echo "‚úÖ Membrane API deployed and healthy"
              curl -s http://localhost:3001/health | head -c 200
              echo ""
            else
              echo "‚ö†Ô∏è Service may still be starting..."
              systemctl status membrane-api --no-pager || true
            fi

